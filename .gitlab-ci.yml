include:
  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/raw/python39/python-tests.yml'
  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/-/raw/k3s-dynamic-tag/k3s-docker-build-multiarch.yml'
  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/-/raw/k3s-dynamic-tag/k3s-deploy.yml'

stages:
  - unittest
  - build
  - release
  - deploy

variables:
  DEPLOYMENT: manifests/deployment.yml

prometheus:
  stage: unittest
  image: python:3.9
  before_script:
    - pip install pipenv
    - pipenv install
  script:
    - pipenv run python pinger.py --debug --interval 1 localhost &
    - TESTPID=$?
    - sleep 5
    - curl -s localhost:8080/metric | grep '^pinger_packet_total{host="localhost"}'
    - curl -s localhost:8080/metric | grep '^pinger_packet_latency_total{host="localhost"}'
    - curl -s localhost:8080/metric | grep '^pinger_packet_loss_total{host="localhost"}'
