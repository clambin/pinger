stages:
  - test
  - build
  - test_build
  - release

.common_only:
  only:
    changes:
      - "*.py"
      - "metrics/*.py"
      - "Dockerfile*"
      - .gitlab-ci.yml

.common_docker:
  image: docker:stable
  services:
    - docker:stable-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_CLI_EXPERIMENTAL: enabled
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USER" --password-stdin

.common_docker_arm:
  # using 17.12. stable doesn't work on RPI (can't connect to docker socket)
  image: docker:17.12
  services:
    - docker:17.12-dind

.common_build:
  extends: .common_only
  extends: .common_docker_arm
  except:
    - tags
  before_script:
    - export VERSION=$(grep -i ^version version.py | awk '{ print $3 }' | tr -d \');
    - if [[ $CI_COMMIT_REF_NAME == "master" ]]; then
        export TAG=$VERSION;
      elif [[ $CI_COMMIT_REF_NAME == "release-$VERSION" ]]; then
        export TAG="dev-$VERSION";
      else
        export TAG="dev";
      fi
    - export CI_PROJECT_PATH=$(echo $CI_PROJECT_PATH | tr "[:upper:]" "[:lower:]")

.common_release:
  extends: .common_build
  extends: .common_docker

flake8:
  extends: .common_only
  image: python:3.7-alpine
  stage: test
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install -U flake8
  script:
    - flake8 --max-line-length 120 *.py metric/*.py

pytest:
  extends: .common_only
  image: python:3.7-alpine
  stage: test
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install pipenv
    - pipenv install
  script:
    - cd tests && pytest

amd64:
  extends: .common_build
  stage: build
  tags:
    - docker
    - shared
  script:
    - docker build --pull
                   -t "$CI_PROJECT_PATH":"$TAG-amd64" .
    - docker push "$CI_PROJECT_PATH":"$TAG-amd64"

arm:
  extends: .common_build
  stage: build
  tags:
    - docker
    - arm
  script:
    - docker build --pull
                   --build-arg BASE_IMAGE=arm32v7/python:3.7-alpine
                   -t "$CI_PROJECT_PATH":"$TAG-arm" .
    - docker push "$CI_PROJECT_PATH":"$TAG-arm"

test_build_amd64:
  extends: .common_docker
  stage: test_build
  tags:
    - docker
    - shared
  script:
    - echo Testing "$CI_PROJECT_PATH":"$TAG"
    - docker run "$CI_PROJECT_PATH":"$TAG-amd64" --once

#test_build_arm:
#  extends: .common_release
#  stage: test_build
#  tags:
#    - docker
#    - arm
#  script:
#    - docker run "$CI_PROJECT_PATH":"$TAG" --once

manifest-tagged:
  extends: .common_release
  stage: release
  tags:
    - docker
    - shared
  script:
    - docker manifest create "$CI_PROJECT_PATH":"$TAG"
      "$CI_PROJECT_PATH":"$TAG-amd64"
      "$CI_PROJECT_PATH":"$TAG-arm"
    - docker manifest push -p "$CI_PROJECT_PATH":"$TAG"

manifest-latest:
  extends: .common_release
  stage: release
  tags:
    - docker
    - shared
  only:
    - master
  script:
    - docker manifest create "$CI_PROJECT_PATH":latest
      "$CI_PROJECT_PATH":"$TAG-amd64"
      "$CI_PROJECT_PATH":"$TAG-arm"
    - docker manifest push -p "$CI_PROJECT_PATH":latest

github:
  # FIXME: what's a suitable (light) image for this?
  image: python:3.7-alpine
  stage: release
  only:
    - master
  script:
    - apk add git
    - git remote set-url origin "https://$GITHUB_USER:$GITHUB_TOKEN@github.com/$CI_PROJECT_PATH.git"
    - git tag $TAG
    - git push --tags
