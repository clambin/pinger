stages:
  - test
  - build

flake8:
  image: python:3.7-alpine
  stage: test
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install -U flake8
  script:
    - flake8 --max-line-length 120 *.py metric/*.py


pytest:
  image: python:3.7-alpine
  stage: test
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install pipenv
    - pipenv install
  script:
    - cd tests && pytest

.common_build: &common_build
  image: docker:17.12
  stage: build
  services:
    - docker:17.12-dind
  variables:
    DOCKER_DRIVER: overlay2
  except:
    - tags
  only:
    changes:
      - "Dockerfile*"
      - "*.py"
      - "metrics/*.py"
      - .gitlab-ci.yml
  before_script:
    - mkdir $HOME/.docker
    - echo '{"experimental":"enabled"}' > $HOME/.docker/config.json
    - export TAG="develop"
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USER" --password-stdin
    - export CI_PROJECT_PATH=$(echo $CI_PROJECT_PATH | tr "[:upper:]" "[:lower:]")

amd64:
  <<: *common_build
  tags:
    - docker
    - shared
  script:
    - docker build --pull
                   --cache-from "$CI_PROJECT_PATH":"$TAG-amd64"
                   -t "$CI_PROJECT_PATH":"$TAG-amd64" .
    - docker push "$CI_PROJECT_PATH":"$TAG-amd64"

arm:
  <<: *common_build
  tags:
    - docker
    - shared
  script:
    - wget https://github.com/multiarch/qemu-user-static/releases/download/v2.12.0/qemu-arm-static -O qemu-arm-static
    - chmod 554 qemu-arm-static
    - docker build --pullchmod 554 qemu-arm-static
                   --cache-from "$CI_PROJECT_PATH":"$TAG-arm"
                   -t "$CI_PROJECT_PATH":"$TAG-arm"
                   --build-arg BASE_IMAGE=arm32v6/python:3.7-alpine
                   -f Dockerfile.gitlab .
    - docker push "$CI_PROJECT_PATH":"$TAG-arm"

